{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoornimaX - Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6; --primary-light: #60a5fa;
            --bg: #f8f9fa; --bg-card: #ffffff;
            --text: #1f2937; --text-light: #6c757d;
            --border: #e9ecef; --shadow: rgba(0, 0, 0, 0.08);
            --radius: 12px; --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 80px; overflow-x: hidden; }
        a { text-decoration: none; color: inherit; }
        button { cursor: pointer; border: none; outline: none; background: transparent; }

        .content-wrapper { max-width: 1000px; margin: 0 auto; padding: 0 15px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 20px; }
        .header-left h2 { font-size: 22px; font-weight: 700; background: linear-gradient(45deg, var(--primary), var(--primary-light)); background-clip: text; -webkit-background-clip: text; color: transparent; }
        header a img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        
        .stats-container { margin-bottom: 40px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .stat-card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; text-align: center; box-shadow: 0 4px 12px var(--shadow); border: 1px solid var(--border); transition: var(--transition); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px var(--shadow); }
        .stat-card-icon { display: grid; place-items: center; width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 15px; margin: 0 auto 12px; }
        .stat-card-icon i { font-size: 24px; color: white; }
        .stat-card p { font-size: 14px; color: var(--text-light); margin-bottom: 8px; font-weight: 500; }
        .stat-card strong { font-size: 24px; color: var(--primary); font-weight: 700; }
        
        .section-divider { height: 1px; background-color: var(--border); margin: 40px 0; }
        .horizontal-section { margin-bottom: 35px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .section-header h2 { font-size: 20px; font-weight: 600; color: var(--text); }
        .section-header-left { display: flex; align-items: center; }
        .section-count { background: linear-gradient(45deg, var(--primary), var(--primary-light)); color: white; font-size: 12px; border-radius: 30px; padding: 3px 10px; margin-left: 10px; font-weight: 500; }
        .scroll-nav { display: flex; gap: 10px; }
        .scroll-nav button { width: 36px; height: 36px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-light); display: grid; place-items: center; transition: var(--transition); }
        .scroll-nav button:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .scroll-container { display: flex; gap: 20px; overflow-x: auto; padding: 10px 5px 20px; scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth; }
        .scroll-container::-webkit-scrollbar { display: none; }
        
        .user-card { flex: 0 0 auto; width: 320px; background-color: var(--bg-card); border-radius: var(--radius); box-shadow: 0 4px 12px var(--shadow); overflow: hidden; display: flex; transition: var(--transition); border: 1px solid var(--border); }
        .user-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px var(--shadow); }
        .profile-link { display: flex; padding: 18px; flex: 1; overflow: hidden;}
        .profile-pic-container { width: 100px; height: 100px; border-radius: 12px; overflow: hidden; margin-right: 15px; flex-shrink: 0; }
        .profile-pic { width: 100%; height: 100%; object-fit: cover; }
        .user-info { display: flex; flex-direction: column; justify-content: center; flex: 1; overflow: hidden; }
        .user-info h3 { font-size: 17px; margin-bottom: 6px; color: var(--text); white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .user-info p { font-size: 13px; color: var(--text-light); margin-bottom: 5px; display: flex; align-items: center; white-space: nowrap; }
        .user-info p i { margin-right: 6px; color: var(--primary-light); font-size: 12px; }
        .heart-form { display: flex; align-items: center; padding-right: 12px; }
        .heart-btn { width: 45px; height: 45px; border-radius: 50%; display: grid; place-items: center; }
        .heart-btn i { font-size: 22px; transition: all 0.2s ease; }
        .empty-card { display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px dashed #dbeafe; border-radius: var(--radius); padding: 40px 20px; text-align: center; width: 100%; color: var(--text-light); }
        .empty-card i { font-size: 36px; color: var(--primary-light); margin-bottom: 15px; }

        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 20px var(--shadow); border-top: 1px solid var(--border); z-index: 100; }
        nav a { display: flex; flex-direction: column; align-items: center; color: var(--text-light); padding: 8px 16px; }
        nav a.active-link { color: var(--primary); font-weight: 600; }
        nav a i { font-size: 22px; margin-bottom: 2px; }
        
        .load-more-trigger { flex-shrink: 0; width: 1px; height: 1px; opacity: 0; }
    </style>
</head>

<body>
    <div class="content-wrapper">
        <header>
            <div class="header-left">
                <h2>Welcome, {{ user.full_name|default:'User' }}</h2>
            </div>
            <a href="{% url 'feed:profile' user_id=user.id %}">
                <img src="{{ user.profile_picture.url }}" alt="Profile" loading="lazy">
            </a>
        </header>
    
        <section class="stats-container">
            <div class="stats">
                <a href="{% url 'feed:hearts_sent' %}" class="stat-card"><div class="stat-card-icon"><i class="fas fa-heart-circle-plus"></i></div><p>Hearts Sent</p><strong id="hearts-sent-stat">{{ hearts_sent }}</strong></a>
                <a href="{% url 'feed:hearts_received' %}" class="stat-card"><div class="stat-card-icon"><i class="fas fa-heart-circle-check"></i></div><p>Hearts Received</p><strong id="hearts-received-stat">{{ hearts_received }}</strong></a>
                <a href="{% url 'feed:friends_list' %}" class="stat-card"><div class="stat-card-icon"><i class="fas fa-user-group"></i></div><p>Friends</p><strong id="friends-stat">{{ friends }}</strong></a>
                <div class="stat-card"><div class="stat-card-icon"><i class="fas fa-eye"></i></div><p>Profile Views</p><strong id="profile-views-stat">{{ profile_views }}</strong></div>
            </div>
        </section>

        <div class="section-divider"></div>
        <section class="horizontal-section">
            <div class="section-header">
                <div class="section-header-left">
                    <h2>Recently Joined</h2>
                    <span class="section-count">{{ recently_joined.paginator.count }}</span>
                </div>
                {% if recently_joined %}<div class="scroll-nav"><button class="scroll-button scroll-left" data-target="recently-joined-container">←</button><button class="scroll-button scroll-right" data-target="recently-joined-container">→</button></div>{% endif %}
            </div>
            <div class="scroll-container" id="recently-joined-container" data-category="recently_joined" data-current-page="1" data-is-loading="false" data-has-next="{{ recently_joined.has_next|yesno:'true,false' }}">
                {% for entry in recently_joined %}
                <div class="user-card" data-user-id="{{ entry.user.id }}">
                    <a href="{% url 'feed:profile' user_id=entry.user.id %}" class="profile-link">
                        <div class="profile-pic-container"><img src="{{ entry.user.profile_picture.url }}" alt="Profile" class="profile-pic" loading="lazy"></div>
                        <div class="user-info">
                            <h3>{{ entry.user.full_name }}</h3>
                            <p><i class="fas fa-graduation-cap"></i>{{ entry.user.department|default:'N/A' }}</p>
                            <p><i class="fas fa-university"></i>{{ entry.user.college|default:'N/A' }}</p>
                        </div>
                    </a>
                    <form class="heart-form">
                        {% csrf_token %}
                        {% if entry.crush_status == 'mutual' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Friend"><i class="fas fa-heart" style="color: #ef4444;"></i></button>
                        {% elif entry.crush_status == 'sent' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Sent"><i class="fas fa-heart" style="color: #ff6584;"></i></button>
                        {% elif entry.crush_status == 'received' %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart Back"><i class="far fa-heart" style="color: rgba(255, 101, 132, 0.8);"></i></button>
                        {% else %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart"><i class="far fa-heart" style="color: var(--text-light);"></i></button>
                        {% endif %}
                    </form>
                </div>
                {% empty %}
                <div class="empty-card"><i class="fas fa-door-open"></i><p>No new users recently.</p></div>
                {% endfor %}
                {% if recently_joined.has_next %}<div class="load-more-trigger"></div>{% endif %}
            </div>
        </section>
        
        <div class="section-divider"></div>
        <section class="horizontal-section">
             <div class="section-header">
                <div class="section-header-left">
                    <h2>Trending</h2>
                    <span class="section-count">{{ trending|length }}</span>
                </div>
                </div>
            <div class="scroll-container" id="trending-container">
                {% for entry in trending %}
                <div class="user-card" data-user-id="{{ entry.user.id }}">
                    <a href="{% url 'feed:profile' user_id=entry.user.id %}" class="profile-link">
                        <div class="profile-pic-container"><img src="{{ entry.user.profile_picture.url }}" alt="Profile" class="profile-pic" loading="lazy"></div>
                        <div class="user-info">
                            <h3>{{ entry.user.full_name }}</h3>
                            <p><i class="fas fa-graduation-cap"></i>{{ entry.user.department|default:'N/A' }}</p>
                            <p><i class="fas fa-university"></i>{{ entry.user.college|default:'N/A' }}</p>
                        </div>
                    </a>
                    <form class="heart-form">
                        {% csrf_token %}
                        {% if entry.crush_status == 'mutual' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Friend"><i class="fas fa-heart" style="color: #ef4444;"></i></button>
                        {% elif entry.crush_status == 'sent' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Sent"><i class="fas fa-heart" style="color: #ff6584;"></i></button>
                        {% elif entry.crush_status == 'received' %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart Back"><i class="far fa-heart" style="color: rgba(255, 101, 132, 0.8);"></i></button>
                        {% else %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart"><i class="far fa-heart" style="color: var(--text-light);"></i></button>
                        {% endif %}
                    </form>
                </div>
                {% empty %}
                <div class="empty-card"><i class="fas fa-fire"></i><p>Nothing is trending right now.</p></div>
                {% endfor %}
                </div>
        </section>
        <div class="section-divider"></div>
        <section class="horizontal-section">
             <div class="section-header">
                <div class="section-header-left">
                    <h2>Same Year</h2>
                    <span class="section-count">{{ same_year.paginator.count }}</span>
                </div>
                {% if same_year %}<div class="scroll-nav"><button class="scroll-button scroll-left" data-target="same-year-container">←</button><button class="scroll-button scroll-right" data-target="same-year-container">→</button></div>{% endif %}
            </div>
            <div class="scroll-container" id="same-year-container" data-category="same_year" data-current-page="1" data-is-loading="false" data-has-next="{{ same_year.has_next|yesno:'true,false' }}">
                {% for entry in same_year %}
                <div class="user-card" data-user-id="{{ entry.user.id }}">
                    <a href="{% url 'feed:profile' user_id=entry.user.id %}" class="profile-link">
                        <div class="profile-pic-container"><img src="{{ entry.user.profile_picture.url }}" alt="Profile" class="profile-pic" loading="lazy"></div>
                        <div class="user-info">
                            <h3>{{ entry.user.full_name }}</h3>
                            <p><i class="fas fa-graduation-cap"></i>{{ entry.user.department|default:'N/A' }}</p>
                            <p><i class="fas fa-university"></i>{{ entry.user.college|default:'N/A' }}</p>
                        </div>
                    </a>
                    <form class="heart-form">
                        {% csrf_token %}
                        {% if entry.crush_status == 'mutual' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Friend"><i class="fas fa-heart" style="color: #ef4444;"></i></button>
                        {% elif entry.crush_status == 'sent' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Sent"><i class="fas fa-heart" style="color: #ff6584;"></i></button>
                        {% elif entry.crush_status == 'received' %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart Back"><i class="far fa-heart" style="color: rgba(255, 101, 132, 0.8);"></i></button>
                        {% else %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart"><i class="far fa-heart" style="color: var(--text-light);"></i></button>
                        {% endif %}
                    </form>
                </div>
                {% empty %}
                <div class="empty-card"><i class="fas fa-search-minus"></i><p>No one from your year has joined yet.</p></div>
                {% endfor %}
                {% if same_year.has_next %}<div class="load-more-trigger"></div>{% endif %}
            </div>
        </section>

        <div class="section-divider"></div>
        <section class="horizontal-section">
             <div class="section-header">
                <div class="section-header-left">
                    <h2>Same Department</h2>
                    <span class="section-count">{{ same_department.paginator.count }}</span>
                </div>
                {% if same_department %}<div class="scroll-nav"><button class="scroll-button scroll-left" data-target="same-department-container">←</button><button class="scroll-button scroll-right" data-target="same-department-container">→</button></div>{% endif %}
            </div>
            <div class="scroll-container" id="same-department-container" data-category="same_department" data-current-page="1" data-is-loading="false" data-has-next="{{ same_department.has_next|yesno:'true,false' }}">
                {% for entry in same_department %}
                <div class="user-card" data-user-id="{{ entry.user.id }}">
                    <a href="{% url 'feed:profile' user_id=entry.user.id %}" class="profile-link">
                        <div class="profile-pic-container"><img src="{{ entry.user.profile_picture.url }}" alt="Profile" class="profile-pic" loading="lazy"></div>
                        <div class="user-info">
                            <h3>{{ entry.user.full_name }}</h3>
                            <p><i class="fas fa-graduation-cap"></i>{{ entry.user.department|default:'N/A' }}</p>
                            <p><i class="fas fa-university"></i>{{ entry.user.college|default:'N/A' }}</p>
                        </div>
                    </a>
                    <form class="heart-form">
                        {% csrf_token %}
                        {% if entry.crush_status == 'mutual' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Friend"><i class="fas fa-heart" style="color: #ef4444;"></i></button>
                        {% elif entry.crush_status == 'sent' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Sent"><i class="fas fa-heart" style="color: #ff6584;"></i></button>
                        {% elif entry.crush_status == 'received' %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart Back"><i class="far fa-heart" style="color: rgba(255, 101, 132, 0.8);"></i></button>
                        {% else %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart"><i class="far fa-heart" style="color: var(--text-light);"></i></button>
                        {% endif %}
                    </form>
                </div>
                {% empty %}
                <div class="empty-card"><i class="fas fa-users-slash"></i><p>Looks quiet... No users from your department found.</p></div>
                {% endfor %}
                {% if same_department.has_next %}<div class="load-more-trigger"></div>{% endif %}
            </div>
        </section>
        
        <div class="section-divider"></div>
        <section class="horizontal-section">
             <div class="section-header">
                <div class="section-header-left">
                    <h2>Same College</h2>
                    <span class="section-count">{{ same_college.paginator.count }}</span>
                </div>
                {% if same_college %}<div class="scroll-nav"><button class="scroll-button scroll-left" data-target="same-college-container">←</button><button class="scroll-button scroll-right" data-target="same-college-container">→</button></div>{% endif %}
            </div>
            <div class="scroll-container" id="same-college-container" data-category="same_college" data-current-page="1" data-is-loading="false" data-has-next="{{ same_college.has_next|yesno:'true,false' }}">
                {% for entry in same_college %}
                <div class="user-card" data-user-id="{{ entry.user.id }}">
                    <a href="{% url 'feed:profile' user_id=entry.user.id %}" class="profile-link">
                        <div class="profile-pic-container"><img src="{{ entry.user.profile_picture.url }}" alt="Profile" class="profile-pic" loading="lazy"></div>
                        <div class="user-info">
                            <h3>{{ entry.user.full_name }}</h3>
                            <p><i class="fas fa-graduation-cap"></i>{{ entry.user.department|default:'N/A' }}</p>
                            <p><i class="fas fa-university"></i>{{ entry.user.college|default:'N/A' }}</p>
                        </div>
                    </a>
                    <form class="heart-form">
                        {% csrf_token %}
                        {% if entry.crush_status == 'mutual' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Friend"><i class="fas fa-heart" style="color: #ef4444;"></i></button>
                        {% elif entry.crush_status == 'sent' %}
                            <button type="submit" name="crush_action" value="uncrush" class="heart-btn" title="Sent"><i class="fas fa-heart" style="color: #ff6584;"></i></button>
                        {% elif entry.crush_status == 'received' %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart Back"><i class="far fa-heart" style="color: rgba(255, 101, 132, 0.8);"></i></button>
                        {% else %}
                             <button type="submit" name="crush_action" value="send_crush" class="heart-btn" title="Send Heart"><i class="far fa-heart" style="color: var(--text-light);"></i></button>
                        {% endif %}
                    </form>
                </div>
                {% empty %}
                <div class="empty-card"><i class="fas fa-school"></i><p>You're a pioneer! No other users from your college found.</p></div>
                {% endfor %}
                {% if same_college.has_next %}<div class="load-more-trigger"></div>{% endif %}
            </div>
        </section>

    </div>

    <nav>
        <a href="{% url 'feed:home' %}" class="active-link"><i class="fas fa-home"></i></a>
        <a href="{% url 'feed:explore' %}"><i class="fas fa-compass"></i></a>
        <a href="{% url 'feed:create_post' %}"><i class="fas fa-plus-circle"></i></a>
        <a href="{% url 'feed:friends_list' %}"><i class="fas fa-user-friends"></i></a>
        <a href="{% url 'chat:inbox' %}"><i class="fas fa-comment"></i></a>
    </nav>
    <script>
    // No changes are needed in the JavaScript. It is already robust enough to handle 
    // sections with and without the lazy loading attributes.
    document.addEventListener('DOMContentLoaded', function() {
        const getCsrfToken = () => document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const updateHeartUI = (button, newStatus) => {
            const icon = button.querySelector('i');
            switch (newStatus) {
                case 'mutual':
                    button.value = 'uncrush';
                    button.title = 'Friend';
                    icon.className = 'fas fa-heart';
                    icon.style.color = '#ef4444'; // Red for mutual
                    break;
                case 'sent':
                    button.value = 'uncrush';
                    button.title = 'Sent';
                    icon.className = 'fas fa-heart';
                    icon.style.color = '#ff6584'; // Pink for sent
                    break;
                case 'received':
                    button.value = 'send_crush';
                    button.title = 'Send Heart Back';
                    icon.className = 'far fa-heart';
                    icon.style.color = 'rgba(255, 101, 132, 0.8)'; // Pink outline for received
                    break;
                default: // 'none'
                    button.value = 'send_crush';
                    button.title = 'Send Heart';
                    icon.className = 'far fa-heart';
                    icon.style.color = 'var(--text-light)'; // Default for none
            }
        };

        const handleHeartFormSubmit = (event) => {
            event.preventDefault();
            const form = event.currentTarget;
            const button = form.querySelector('.heart-btn');
            const userCard = form.closest('.user-card');
            const userId = userCard.dataset.userId;
            const action = button.value;
            const url = `/feed/crush_action/${userId}/`;
            const formData = new FormData();
            formData.append('crush_action', action);
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            fetch(url, { method: 'POST', body: formData })
                .then(response => response.ok ? response.json() : Promise.reject(response))
                .then(data => {
                    if (data.status === 'ok') {
                        document.getElementById('hearts-sent-stat').textContent = data.stats.hearts_sent;
                        document.getElementById('hearts-received-stat').textContent = data.stats.hearts_received;
                        document.getElementById('friends-stat').textContent = data.stats.friends;
                        updateHeartUI(button, data.new_crush_status);
                    } else { alert(`Error: ${data.message}`); }
                })
                .catch(error => console.error('Action error:', error));
        };
        
        const addHeartFormListeners = (container) => {
            container.querySelectorAll('.heart-form').forEach(form => {
                form.removeEventListener('submit', handleHeartFormSubmit);
                form.addEventListener('submit', handleHeartFormSubmit);
            });
        };
        addHeartFormListeners(document.body);

        const fetchUpdates = () => {
            fetch('/feed/get-home-updates/')
                .then(response => response.ok ? response.json() : Promise.reject(response))
                .then(data => {
                    document.getElementById('hearts-sent-stat').textContent = data.stats.hearts_sent;
                    document.getElementById('hearts-received-stat').textContent = data.stats.hearts_received;
                    document.getElementById('friends-stat').textContent = data.stats.friends;
                    document.getElementById('profile-views-stat').textContent = data.stats.profile_views;
                })
                .catch(error => console.error('Polling error:', error));
        };
        setInterval(fetchUpdates, 15000);

        document.querySelectorAll('.scroll-button').forEach(button => {
            button.addEventListener('click', function() {
                const container = document.getElementById(this.dataset.target);
                if (container) {
                    const scrollAmount = container.clientWidth * 0.8;
                    const direction = this.classList.contains('scroll-left') ? -1 : 1;
                    container.scrollBy({ left: scrollAmount * direction, behavior: 'smooth' });
                }
            });
        });

        const createUserCardHTML = (user) => {
            let heartDetails;
            switch (user.crush_status) {
                case 'mutual':
                    heartDetails = { icon: 'fas fa-heart', color: '#ef4444', action: 'uncrush', title: 'Friend' };
                    break;
                case 'sent':
                    heartDetails = { icon: 'fas fa-heart', color: '#ff6584', action: 'uncrush', title: 'Sent' };
                    break;
                case 'received':
                    heartDetails = { icon: 'far fa-heart', color: 'rgba(255, 101, 132, 0.8)', action: 'send_crush', title: 'Send Heart Back' };
                    break;
                default: // 'none'
                    heartDetails = { icon: 'far fa-heart', color: 'var(--text-light)', action: 'send_crush', title: 'Send Heart' };
            }
            
            return `
            <div class="user-card" data-user-id="${user.id}">
                <a href="/feed/profile/${user.id}/" class="profile-link">
                    <div class="profile-pic-container"><img src="${user.profile_picture_url}" alt="Profile" class="profile-pic" loading="lazy"></div>
                    <div class="user-info">
                        <h3>${user.full_name}</h3>
                        <p><i class="fas fa-graduation-cap"></i>${user.department}</p>
                        <p><i class="fas fa-university"></i>${user.college}</p>
                    </div>
                </a>
                <form class="heart-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${getCsrfToken()}">
                    <button type="submit" name="crush_action" value="${heartDetails.action}" class="heart-btn" title="${heartDetails.title}">
                        <i class="${heartDetails.icon}" style="color: ${heartDetails.color};"></i>
                    </button>
                </form>
            </div>`;
        };
        
        const loadMoreUsers = (container) => {
            const category = container.dataset.category;
            let currentPage = parseInt(container.dataset.currentPage, 10);
            const nextPage = currentPage + 1;
            container.dataset.isLoading = 'true';
            
            fetch(`/api/load-users/?category=${category}&page=${nextPage}`)
                .then(response => response.ok ? response.json() : Promise.reject(response))
                .then(data => {
                    if (data.status === 'ok' && data.users.length > 0) {
                        const newCardsHTML = data.users.map(createUserCardHTML).join('');
                        const trigger = container.querySelector('.load-more-trigger');
                        if (trigger) {
                            trigger.insertAdjacentHTML('beforebegin', newCardsHTML);
                        } else {
                            container.insertAdjacentHTML('beforeend', newCardsHTML);
                        }
                        container.dataset.currentPage = nextPage;
                        container.dataset.hasNext = data.has_next;
                        addHeartFormListeners(container); 
                        if (!data.has_next && trigger) { trigger.remove(); }
                    } else {
                        const trigger = container.querySelector('.load-more-trigger');
                        if (trigger) trigger.remove();
                    }
                })
                .catch(error => console.error(`Error loading ${category}:`, error))
                .finally(() => { container.dataset.isLoading = 'false'; });
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const container = entry.target.parentElement;
                    if (container.dataset.isLoading === 'false' && container.dataset.hasNext === 'true') {
                        loadMoreUsers(container);
                    }
                }
            });
        }, { root: null, rootMargin: '0px 200px 0px 200px', threshold: 0.1 });

        document.querySelectorAll('.load-more-trigger').forEach(trigger => { observer.observe(trigger); });
    });
    </script>
</body>
</html>